<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS Integration Testing - Onboarding Portal</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .header-section { background: #e9ecef; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Frontend-Backend Integration Test Suite</h1>
    
    <div class="test-section">
        <h2>Configuration Summary</h2>
        <div id="config-info" class="info">
            <strong>Frontend Dev Server:</strong> http://localhost:3002<br>
            <strong>Backend API:</strong> http://localhost:8000 (via Docker)<br>
            <strong>Next.js API Proxy:</strong> /api/* → http://localhost:8000/api/*<br>
            <strong>CORS Allowed Origins:</strong> http://localhost:3000, 3001, 3002, 3004
        </div>
    </div>

    <div class="test-section">
        <h2>1. CORS Preflight Test</h2>
        <button onclick="testCORSPreflight()">Test CORS Preflight</button>
        <div id="cors-preflight-result"></div>
    </div>

    <div class="test-section">
        <h2>2. Direct Backend API Test</h2>
        <button onclick="testDirectBackend()">Test Direct Backend</button>
        <div id="direct-backend-result"></div>
    </div>

    <div class="test-section">
        <h2>3. Next.js Proxy API Test</h2>
        <button onclick="testProxyAPI()">Test Proxy API</button>
        <div id="proxy-api-result"></div>
    </div>

    <div class="test-section">
        <h2>4. Authentication Flow Test</h2>
        <button onclick="testAuthFlow()">Test Auth Flow</button>
        <div id="auth-flow-result"></div>
    </div>

    <div class="test-section">
        <h2>5. Security Headers Check</h2>
        <button onclick="testSecurityHeaders()">Check Security Headers</button>
        <div id="security-headers-result"></div>
    </div>

    <div class="test-section">
        <h2>6. Duplicate Headers Check</h2>
        <button onclick="testDuplicateHeaders()">Check Duplicate Headers</button>
        <div id="duplicate-headers-result"></div>
    </div>

    <div class="test-section">
        <h2>7. Critical Endpoints Test</h2>
        <button onclick="testAllEndpoints()">Test All Critical Endpoints</button>
        <div id="all-endpoints-result"></div>
    </div>

    <div class="test-section">
        <h2>Console Errors Monitor</h2>
        <div id="console-errors" class="info">
            <strong>Console Errors:</strong> <span id="error-count">0</span><br>
            <div id="error-list"></div>
        </div>
    </div>

    <script>
        // Error monitoring
        let errorCount = 0;
        const originalConsoleError = console.error;
        console.error = function(...args) {
            errorCount++;
            document.getElementById('error-count').textContent = errorCount;
            const errorDiv = document.createElement('div');
            errorDiv.innerHTML = `<small>${new Date().toLocaleTimeString()}: ${args.join(' ')}</small>`;
            document.getElementById('error-list').appendChild(errorDiv);
            originalConsoleError.apply(console, args);
        };

        // Utility functions
        function logResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = message;
            element.appendChild(resultDiv);
        }

        function formatHeaders(headers) {
            const headerObj = {};
            if (headers.forEach) {
                headers.forEach((value, name) => {
                    headerObj[name] = value;
                });
            } else {
                for (const [name, value] of Object.entries(headers)) {
                    headerObj[name] = value;
                }
            }
            return JSON.stringify(headerObj, null, 2);
        }

        // Test 1: CORS Preflight
        async function testCORSPreflight() {
            document.getElementById('cors-preflight-result').innerHTML = '';
            logResult('cors-preflight-result', 'Testing CORS preflight request...', 'info');
            
            try {
                const response = await fetch('http://localhost:8000/api/health', {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': 'http://localhost:3002',
                        'Access-Control-Request-Method': 'GET',
                        'Access-Control-Request-Headers': 'Authorization, Content-Type'
                    }
                });

                logResult('cors-preflight-result', 
                    `✅ CORS Preflight: ${response.status} ${response.statusText}<br>
                    <div class="header-section">
                        <strong>Response Headers:</strong><br>
                        <pre>${formatHeaders(response.headers)}</pre>
                    </div>`, 
                    response.ok ? 'success' : 'error');
                
            } catch (error) {
                logResult('cors-preflight-result', `❌ CORS Preflight Error: ${error.message}`, 'error');
            }
        }

        // Test 2: Direct Backend API
        async function testDirectBackend() {
            document.getElementById('direct-backend-result').innerHTML = '';
            logResult('direct-backend-result', 'Testing direct backend API...', 'info');
            
            try {
                const response = await fetch('http://localhost:8000/api/health', {
                    method: 'GET',
                    headers: {
                        'Origin': 'http://localhost:3002',
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                logResult('direct-backend-result', 
                    `✅ Direct Backend: ${response.status} ${response.statusText}<br>
                    <strong>Data:</strong> <pre>${JSON.stringify(data, null, 2)}</pre>
                    <div class="header-section">
                        <strong>Response Headers:</strong><br>
                        <pre>${formatHeaders(response.headers)}</pre>
                    </div>`, 
                    response.ok ? 'success' : 'error');
                
            } catch (error) {
                logResult('direct-backend-result', `❌ Direct Backend Error: ${error.message}`, 'error');
            }
        }

        // Test 3: Next.js Proxy API
        async function testProxyAPI() {
            document.getElementById('proxy-api-result').innerHTML = '';
            logResult('proxy-api-result', 'Testing Next.js API proxy...', 'info');
            
            try {
                const response = await fetch('/api/health', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                logResult('proxy-api-result', 
                    `✅ Proxy API: ${response.status} ${response.statusText}<br>
                    <strong>Data:</strong> <pre>${JSON.stringify(data, null, 2)}</pre>
                    <div class="header-section">
                        <strong>Response Headers:</strong><br>
                        <pre>${formatHeaders(response.headers)}</pre>
                    </div>`, 
                    response.ok ? 'success' : 'error');
                
            } catch (error) {
                logResult('proxy-api-result', `❌ Proxy API Error: ${error.message}`, 'error');
            }
        }

        // Test 4: Authentication Flow
        async function testAuthFlow() {
            document.getElementById('auth-flow-result').innerHTML = '';
            logResult('auth-flow-result', 'Testing authentication flow...', 'info');
            
            try {
                // Step 1: Get CSRF token
                const csrfResponse = await fetch('/sanctum/csrf-cookie', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                logResult('auth-flow-result', 
                    `Step 1 - CSRF Token: ${csrfResponse.status} ${csrfResponse.statusText}`, 
                    csrfResponse.ok ? 'success' : 'error');

                // Step 2: Try login (expect validation error since no credentials)
                const loginResponse = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        email: 'test@example.com',
                        password: 'testpassword'
                    })
                });

                const loginData = await loginResponse.json();
                
                logResult('auth-flow-result', 
                    `Step 2 - Login Attempt: ${loginResponse.status} ${loginResponse.statusText}<br>
                    <strong>Response:</strong> <pre>${JSON.stringify(loginData, null, 2)}</pre>`, 
                    'info');

                // Step 3: Test protected endpoint
                const protectedResponse = await fetch('/api/user', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': 'Bearer test-token'
                    },
                    credentials: 'include'
                });

                const protectedData = await protectedResponse.text();
                
                logResult('auth-flow-result', 
                    `Step 3 - Protected Endpoint: ${protectedResponse.status} ${protectedResponse.statusText}<br>
                    <strong>Response:</strong> <pre>${protectedData}</pre>`, 
                    'info');

            } catch (error) {
                logResult('auth-flow-result', `❌ Auth Flow Error: ${error.message}`, 'error');
            }
        }

        // Test 5: Security Headers
        async function testSecurityHeaders() {
            document.getElementById('security-headers-result').innerHTML = '';
            logResult('security-headers-result', 'Checking security headers...', 'info');
            
            const requiredHeaders = [
                'x-content-type-options',
                'x-frame-options', 
                'x-xss-protection',
                'referrer-policy'
            ];
            
            try {
                const response = await fetch('/api/health');
                const headers = response.headers;
                
                const foundHeaders = {};
                const missingHeaders = [];
                
                requiredHeaders.forEach(header => {
                    const value = headers.get(header);
                    if (value) {
                        foundHeaders[header] = value;
                    } else {
                        missingHeaders.push(header);
                    }
                });
                
                logResult('security-headers-result', 
                    `<strong>Found Security Headers:</strong><br>
                    <pre>${JSON.stringify(foundHeaders, null, 2)}</pre>
                    ${missingHeaders.length > 0 ? 
                        `<strong>❌ Missing Headers:</strong> ${missingHeaders.join(', ')}` : 
                        '✅ All required security headers present'}`, 
                    missingHeaders.length > 0 ? 'error' : 'success');
                
            } catch (error) {
                logResult('security-headers-result', `❌ Security Headers Error: ${error.message}`, 'error');
            }
        }

        // Test 6: Duplicate Headers
        async function testDuplicateHeaders() {
            document.getElementById('duplicate-headers-result').innerHTML = '';
            logResult('duplicate-headers-result', 'Checking for duplicate headers...', 'info');
            
            try {
                const directResponse = await fetch('http://localhost:8000/api/health', {
                    headers: { 'Origin': 'http://localhost:3002' }
                });
                
                const proxyResponse = await fetch('/api/health');
                
                // Check for CORS header duplication
                const directCorsHeaders = [];
                const proxyCorsHeaders = [];
                
                directResponse.headers.forEach((value, name) => {
                    if (name.toLowerCase().includes('cors') || name.toLowerCase().includes('origin')) {
                        directCorsHeaders.push(`${name}: ${value}`);
                    }
                });
                
                proxyResponse.headers.forEach((value, name) => {
                    if (name.toLowerCase().includes('cors') || name.toLowerCase().includes('origin')) {
                        proxyCorsHeaders.push(`${name}: ${value}`);
                    }
                });
                
                logResult('duplicate-headers-result', 
                    `<strong>Direct Backend CORS Headers:</strong><br>
                    <pre>${directCorsHeaders.join('\\n') || 'None found'}</pre>
                    <strong>Proxy API CORS Headers:</strong><br>
                    <pre>${proxyCorsHeaders.join('\\n') || 'None found'}</pre>
                    ${directCorsHeaders.length > 1 || proxyCorsHeaders.length > 1 ? 
                        '⚠️ Potential duplicate CORS headers detected' : 
                        '✅ No obvious CORS header duplication'}`, 
                    'info');
                
            } catch (error) {
                logResult('duplicate-headers-result', `❌ Duplicate Headers Check Error: ${error.message}`, 'error');
            }
        }

        // Test 7: All Critical Endpoints
        async function testAllEndpoints() {
            document.getElementById('all-endpoints-result').innerHTML = '';
            logResult('all-endpoints-result', 'Testing all critical endpoints...', 'info');
            
            const endpoints = [
                { url: '/api/health', method: 'GET', name: 'Health Check' },
                { url: '/api/auth/me', method: 'GET', name: 'Auth Me' },
                { url: '/api/gamification/profile', method: 'GET', name: 'Gamification Profile' },
                { url: '/api/health-questionnaire', method: 'GET', name: 'Health Questionnaire' },
                { url: '/sanctum/csrf-cookie', method: 'GET', name: 'CSRF Cookie' }
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint.url, {
                        method: endpoint.method,
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });
                    
                    logResult('all-endpoints-result', 
                        `${endpoint.name}: ${response.status} ${response.statusText}`, 
                        response.ok || response.status === 401 || response.status === 422 ? 'success' : 'error');
                        
                } catch (error) {
                    logResult('all-endpoints-result', 
                        `${endpoint.name}: ❌ ${error.message}`, 'error');
                }
            }
        }

        // Auto-run basic tests on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                logResult('config-info', '🚀 Starting automatic integration tests...', 'info');
                testCORSPreflight();
                setTimeout(() => testDirectBackend(), 1000);
                setTimeout(() => testProxyAPI(), 2000);
                setTimeout(() => testSecurityHeaders(), 3000);
            }, 1000);
        });
    </script>
</body>
</html>