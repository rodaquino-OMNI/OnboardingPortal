# ProxySQL Configuration for MySQL High Availability
# This configuration provides intelligent load balancing and connection routing

datadir="/var/lib/proxysql"

# Admin interface configuration
admin_variables={
    admin_credentials="admin:admin;cluster_user:cluster_pass"
    mysql_ifaces="0.0.0.0:6032"
    refresh_interval=2000
    debug=false
    cluster_username="cluster_user"
    cluster_password="cluster_pass"
    cluster_check_interval_ms=1000
    cluster_check_status_frequency=100
    cluster_mysql_query_rules_diffs_before_sync=3
    cluster_mysql_servers_diffs_before_sync=3
    cluster_mysql_users_diffs_before_sync=3
    cluster_proxysql_servers_diffs_before_sync=3
    cluster_mysql_query_rules_save_to_disk=true
    cluster_mysql_servers_save_to_disk=true
    cluster_mysql_users_save_to_disk=true
    cluster_proxysql_servers_save_to_disk=true
}

# MySQL interface configuration
mysql_variables={
    threads=4
    max_connections=2048
    default_query_delay=0
    default_query_timeout=36000000
    have_compress=true
    poll_timeout=2000
    interfaces="0.0.0.0:6033"
    default_schema="omni_portal"
    stacksize=1048576
    server_version="8.0.35"
    connect_timeout_server=3000
    monitor_username="proxysql"
    monitor_password="proxysql123"
    monitor_history=600000
    monitor_connect_interval=60000
    monitor_ping_interval=10000
    monitor_read_only_interval=1500
    monitor_read_only_timeout=500
    ping_interval_server_msec=120000
    ping_timeout_server=500
    commands_stats=true
    sessions_sort=true
    connect_retries_on_failure=10
    health_check_delay_ms=1000
    health_check_delay_ms_timeout=800
    health_check_max_timeout_count=3
}

# MySQL Servers configuration
mysql_servers=(
    {
        address="mysql-master"
        port=3306
        hostgroup=0
        status="ONLINE"
        weight=1000
        compression=0
        max_connections=500
        max_replication_lag=10
        use_ssl=0
        max_latency_ms=1000
        comment="MySQL Master"
    },
    {
        address="mysql-slave-1"
        port=3306
        hostgroup=1
        status="ONLINE"
        weight=900
        compression=0
        max_connections=500
        max_replication_lag=30
        use_ssl=0
        max_latency_ms=1000
        comment="MySQL Slave 1"
    },
    {
        address="mysql-slave-2"
        port=3306
        hostgroup=1
        status="ONLINE"
        weight=900
        compression=0
        max_connections=500
        max_replication_lag=30
        use_ssl=0
        max_latency_ms=1000
        comment="MySQL Slave 2"
    }
)

# MySQL Users configuration
mysql_users=(
    {
        username="omni_user"
        password="omnipass123"
        default_hostgroup=0
        max_connections=100
        default_schema="omni_portal"
        active=1
        comment="Application write user"
    },
    {
        username="omni_reader"
        password="omnireader123"
        default_hostgroup=1
        max_connections=200
        default_schema="omni_portal"
        active=1
        comment="Application read user"
    }
)

# Query routing rules
mysql_query_rules=(
    {
        rule_id=1
        active=1
        match_pattern="^SELECT.*FOR UPDATE"
        destination_hostgroup=0
        apply=1
        comment="SELECT FOR UPDATE to master"
    },
    {
        rule_id=2
        active=1
        match_pattern="^SELECT.*"
        destination_hostgroup=1
        apply=1
        comment="SELECT queries to slaves"
    },
    {
        rule_id=3
        active=1
        match_pattern="^INSERT.*"
        destination_hostgroup=0
        apply=1
        comment="INSERT queries to master"
    },
    {
        rule_id=4
        active=1
        match_pattern="^UPDATE.*"
        destination_hostgroup=0
        apply=1
        comment="UPDATE queries to master"
    },
    {
        rule_id=5
        active=1
        match_pattern="^DELETE.*"
        destination_hostgroup=0
        apply=1
        comment="DELETE queries to master"
    },
    {
        rule_id=6
        active=1
        match_pattern="^CREATE.*"
        destination_hostgroup=0
        apply=1
        comment="CREATE queries to master"
    },
    {
        rule_id=7
        active=1
        match_pattern="^DROP.*"
        destination_hostgroup=0
        apply=1
        comment="DROP queries to master"
    },
    {
        rule_id=8
        active=1
        match_pattern="^ALTER.*"
        destination_hostgroup=0
        apply=1
        comment="ALTER queries to master"
    },
    {
        rule_id=9
        active=1
        match_pattern="^REPLACE.*"
        destination_hostgroup=0
        apply=1
        comment="REPLACE queries to master"
    },
    {
        rule_id=10
        active=1
        match_pattern="^CALL.*"
        destination_hostgroup=0
        apply=1
        comment="Stored procedures to master"
    }
)

# Scheduler configuration for health checks
scheduler=(
    {
        id=1
        active=1
        interval_ms=5000
        filename="/usr/bin/proxysql_galera_checker"
        arg1="0"
        arg2="1"
        arg3="1"
        arg4="1"
        arg5="/var/lib/proxysql/proxysql_galera_checker.log"
        comment="Galera checker"
    }
)