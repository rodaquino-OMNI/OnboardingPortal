<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCR Serialization Fix Verification</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { padding: 10px; margin: 5px 0; border-radius: 5px; }
        .pass { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .fail { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        #upload-area { border: 2px dashed #ccc; padding: 40px; text-align: center; margin: 20px 0; }
        #upload-area:hover { border-color: #999; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        #results { margin-top: 20px; max-height: 400px; overflow-y: auto; }
        .progress { background-color: #e9ecef; border-radius: 10px; margin: 10px 0; }
        .progress-bar { background-color: #007bff; height: 20px; border-radius: 10px; text-align: center; line-height: 20px; color: white; transition: width 0.3s; }
    </style>
</head>
<body>
    <h1>üîç OCR Serialization Fix Verification</h1>
    
    <div class="info">
        <h3>Purpose:</h3>
        <p>This page verifies that the OCR web worker serialization fix properly handles:</p>
        <ul>
            <li>‚úÖ ImageData objects converted to ArrayBuffer</li>
            <li>‚úÖ File objects converted to ArrayBuffer</li>
            <li>‚úÖ Blob objects converted to ArrayBuffer</li>
            <li>‚úÖ String data (base64/URLs) passed through</li>
            <li>üö´ No more DataCloneError exceptions</li>
        </ul>
    </div>

    <h2>Test Controls</h2>
    <button onclick="runSerializationTests()">üß™ Run Serialization Tests</button>
    <button onclick="testWithMockData()">üìä Test with Mock Data</button>
    <button onclick="clearResults()">üóëÔ∏è Clear Results</button>

    <h2>File Upload Test</h2>
    <div id="upload-area" onclick="document.getElementById('file-input').click()">
        <p>üìÅ Click here to select an image file for OCR testing</p>
        <small>This will test real File object serialization</small>
    </div>
    <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="testFileUpload(this)">

    <h2>Test Results</h2>
    <div id="results"></div>

    <script type="module">
        let testResults = [];

        function logResult(message, passed, details = '') {
            const result = { message, passed, details, timestamp: new Date().toISOString() };
            testResults.push(result);
            
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${passed ? 'pass' : 'fail'}`;
            resultDiv.innerHTML = `
                <strong>${passed ? '‚úÖ' : '‚ùå'} ${message}</strong>
                ${details ? `<br><small>${details}</small>` : ''}
                <br><em>${new Date().toLocaleTimeString()}</em>
            `;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function logInfo(message, details = '') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result info';
            resultDiv.innerHTML = `
                <strong>‚ÑπÔ∏è ${message}</strong>
                ${details ? `<br><small>${details}</small>` : ''}
            `;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            testResults = [];
            logInfo('Test results cleared');
        }

        // Test 1: Worker Creation and Basic Serialization
        async function testWorkerCreation() {
            try {
                logInfo('Testing Web Worker creation...');
                
                const workerScript = `
                    self.onmessage = function(e) {
                        const { type, payload } = e.data;
                        
                        try {
                            if (type === 'TEST_SERIALIZATION') {
                                // Test different data types
                                const results = {
                                    arrayBuffer: payload.arrayBuffer instanceof ArrayBuffer,
                                    string: typeof payload.string === 'string',
                                    object: typeof payload.object === 'object'
                                };
                                
                                self.postMessage({ type: 'SUCCESS', payload: results });
                            }
                        } catch (error) {
                            self.postMessage({ type: 'ERROR', payload: error.message });
                        }
                    };
                `;

                const blob = new Blob([workerScript], { type: 'application/javascript' });
                const worker = new Worker(URL.createObjectURL(blob));

                return new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Worker test timeout'));
                    }, 5000);

                    worker.onmessage = (e) => {
                        clearTimeout(timeout);
                        const { type, payload } = e.data;
                        
                        if (type === 'SUCCESS') {
                            logResult('Worker serialization test', true, 
                                `ArrayBuffer: ${payload.arrayBuffer}, String: ${payload.string}, Object: ${payload.object}`);
                            resolve(payload);
                        } else if (type === 'ERROR') {
                            logResult('Worker serialization test', false, payload);
                            reject(new Error(payload));
                        }
                    };

                    worker.onerror = (error) => {
                        clearTimeout(timeout);
                        logResult('Worker creation', false, error.message);
                        reject(error);
                    };

                    // Test serialization with different data types
                    try {
                        worker.postMessage({
                            type: 'TEST_SERIALIZATION',
                            payload: {
                                arrayBuffer: new ArrayBuffer(8),
                                string: 'test string',
                                object: { test: 'value' }
                            }
                        });
                    } catch (error) {
                        clearTimeout(timeout);
                        logResult('postMessage serialization', false, error.message);
                        reject(error);
                    }
                });

            } catch (error) {
                logResult('Worker creation setup', false, error.message);
                throw error;
            }
        }

        // Test 2: ImageData Conversion
        async function testImageDataSerialization() {
            try {
                logInfo('Testing ImageData serialization...');
                
                // Create test ImageData
                const canvas = document.createElement('canvas');
                canvas.width = 10;
                canvas.height = 10;
                const ctx = canvas.getContext('2d');
                
                // Fill with test pattern
                ctx.fillStyle = 'red';
                ctx.fillRect(0, 0, 5, 5);
                ctx.fillStyle = 'blue';
                ctx.fillRect(5, 5, 5, 5);
                
                const imageData = ctx.getImageData(0, 0, 10, 10);
                
                // Test the actual conversion logic from web-worker-ocr.ts
                const canvas2 = document.createElement('canvas');
                canvas2.width = imageData.width;
                canvas2.height = imageData.height;
                const ctx2 = canvas2.getContext('2d');
                
                if (ctx2) {
                    ctx2.putImageData(imageData, 0, 0);
                    
                    return new Promise((resolve, reject) => {
                        canvas2.toBlob(async (blob) => {
                            try {
                                if (blob) {
                                    const arrayBuffer = await blob.arrayBuffer();
                                    
                                    // Test that the ArrayBuffer can be serialized
                                    const testWorker = new Worker(URL.createObjectURL(new Blob([`
                                        self.onmessage = function(e) {
                                            try {
                                                const { imageData } = e.data;
                                                self.postMessage({ 
                                                    type: 'SUCCESS', 
                                                    payload: { 
                                                        isArrayBuffer: imageData instanceof ArrayBuffer,
                                                        size: imageData.byteLength 
                                                    } 
                                                });
                                            } catch (error) {
                                                self.postMessage({ type: 'ERROR', payload: error.message });
                                            }
                                        };
                                    `], { type: 'application/javascript' })));

                                    testWorker.onmessage = (e) => {
                                        const { type, payload } = e.data;
                                        if (type === 'SUCCESS') {
                                            logResult('ImageData to ArrayBuffer conversion', 
                                                payload.isArrayBuffer, 
                                                `Converted to ArrayBuffer of ${payload.size} bytes`);
                                            resolve(payload);
                                        } else {
                                            logResult('ImageData serialization', false, payload);
                                            reject(new Error(payload));
                                        }
                                    };

                                    testWorker.postMessage({ imageData: arrayBuffer });
                                } else {
                                    throw new Error('Failed to convert canvas to blob');
                                }
                            } catch (error) {
                                logResult('ImageData conversion process', false, error.message);
                                reject(error);
                            }
                        }, 'image/png');
                    });
                } else {
                    throw new Error('Failed to create canvas context');
                }
            } catch (error) {
                logResult('ImageData serialization setup', false, error.message);
                throw error;
            }
        }

        // Test 3: DataCloneError Prevention
        async function testDataCloneErrorPrevention() {
            try {
                logInfo('Testing DataCloneError prevention...');
                
                // Create objects that would normally cause DataCloneError
                const problematicObjects = [
                    { 
                        name: 'Function',
                        obj: function() { return 'test'; },
                        shouldFail: true
                    },
                    { 
                        name: 'ArrayBuffer',
                        obj: new ArrayBuffer(16),
                        shouldFail: false
                    },
                    { 
                        name: 'ImageData',
                        obj: new ImageData(new Uint8ClampedArray(400), 10, 10),
                        shouldFail: true // Without conversion
                    }
                ];

                for (const test of problematicObjects) {
                    try {
                        const testWorker = new Worker(URL.createObjectURL(new Blob([`
                            self.onmessage = function(e) {
                                self.postMessage({ type: 'RECEIVED', data: typeof e.data });
                            };
                        `], { type: 'application/javascript' })));

                        await new Promise((resolve, reject) => {
                            const timeout = setTimeout(() => reject(new Error('Timeout')), 1000);
                            
                            testWorker.onmessage = () => {
                                clearTimeout(timeout);
                                resolve();
                            };

                            try {
                                testWorker.postMessage(test.obj);
                                if (test.shouldFail) {
                                    logResult(`${test.name} direct serialization`, false, 
                                        'Should have thrown DataCloneError but did not');
                                } else {
                                    logResult(`${test.name} direct serialization`, true, 
                                        'Properly serialized without error');
                                }
                            } catch (error) {
                                clearTimeout(timeout);
                                if (test.shouldFail && error.name === 'DataCloneError') {
                                    logResult(`${test.name} DataCloneError detection`, true, 
                                        'Correctly threw DataCloneError as expected');
                                } else if (!test.shouldFail) {
                                    logResult(`${test.name} unexpected serialization failure`, false, error.message);
                                }
                                resolve();
                            }
                        });

                    } catch (error) {
                        logResult(`${test.name} test setup`, false, error.message);
                    }
                }
            } catch (error) {
                logResult('DataCloneError prevention test', false, error.message);
            }
        }

        // Main test runner
        async function runSerializationTests() {
            clearResults();
            logInfo('üöÄ Starting OCR Serialization Fix Verification Tests');
            
            const tests = [
                { name: 'Worker Creation', fn: testWorkerCreation },
                { name: 'ImageData Serialization', fn: testImageDataSerialization },
                { name: 'DataCloneError Prevention', fn: testDataCloneErrorPrevention }
            ];

            let passedTests = 0;
            let totalTests = tests.length;

            for (const test of tests) {
                try {
                    logInfo(`Running ${test.name}...`);
                    await test.fn();
                    passedTests++;
                    logResult(`${test.name} suite`, true, 'All sub-tests passed');
                } catch (error) {
                    logResult(`${test.name} suite`, false, error.message);
                }
            }

            // Summary
            const overallPassed = passedTests === totalTests;
            logResult('Overall Test Suite', overallPassed, 
                `${passedTests}/${totalTests} test suites passed`);

            if (overallPassed) {
                logInfo('üéâ All serialization tests passed! The DataCloneError fix is working correctly.');
            } else {
                logInfo('‚ö†Ô∏è Some tests failed. Review the results above for details.');
            }
        }

        // Mock data test
        async function testWithMockData() {
            logInfo('üé≠ Testing with mock data types...');
            
            const mockTests = [
                {
                    name: 'Base64 String',
                    data: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==',
                    expectedType: 'string'
                },
                {
                    name: 'ArrayBuffer',
                    data: new ArrayBuffer(8),
                    expectedType: 'object'
                },
                {
                    name: 'Uint8Array',
                    data: new Uint8Array([1, 2, 3, 4]),
                    expectedType: 'object'
                }
            ];

            for (const test of mockTests) {
                try {
                    const worker = new Worker(URL.createObjectURL(new Blob([`
                        self.onmessage = function(e) {
                            try {
                                const data = e.data.testData;
                                self.postMessage({ 
                                    type: 'SUCCESS', 
                                    payload: { 
                                        receivedType: typeof data,
                                        isArrayBuffer: data instanceof ArrayBuffer,
                                        isUint8Array: data instanceof Uint8Array,
                                        constructor: data.constructor.name
                                    } 
                                });
                            } catch (error) {
                                self.postMessage({ type: 'ERROR', payload: error.message });
                            }
                        };
                    `], { type: 'application/javascript' })));

                    await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => reject(new Error('Timeout')), 2000);

                        worker.onmessage = (e) => {
                            clearTimeout(timeout);
                            const { type, payload } = e.data;
                            
                            if (type === 'SUCCESS') {
                                logResult(`Mock ${test.name} serialization`, true,
                                    `Type: ${payload.receivedType}, Constructor: ${payload.constructor}, ArrayBuffer: ${payload.isArrayBuffer}`);
                            } else {
                                logResult(`Mock ${test.name} serialization`, false, payload);
                            }
                            resolve();
                        };

                        worker.onerror = (error) => {
                            clearTimeout(timeout);
                            logResult(`Mock ${test.name} worker error`, false, error.message);
                            resolve();
                        };

                        try {
                            worker.postMessage({ testData: test.data });
                        } catch (error) {
                            clearTimeout(timeout);
                            if (error.name === 'DataCloneError') {
                                logResult(`Mock ${test.name} DataCloneError`, false, 
                                    'This data type cannot be serialized and needs conversion');
                            } else {
                                logResult(`Mock ${test.name} postMessage error`, false, error.message);
                            }
                            resolve();
                        }
                    });

                } catch (error) {
                    logResult(`Mock ${test.name} setup`, false, error.message);
                }
            }
        }

        // File upload test
        async function testFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            logInfo(`üìÑ Testing file upload: ${file.name} (${file.size} bytes)`);

            try {
                // Test File to ArrayBuffer conversion
                const arrayBuffer = await file.arrayBuffer();
                
                logResult('File to ArrayBuffer conversion', true, 
                    `Converted ${file.name} to ArrayBuffer of ${arrayBuffer.byteLength} bytes`);

                // Test serialization
                const worker = new Worker(URL.createObjectURL(new Blob([`
                    self.onmessage = function(e) {
                        try {
                            const { arrayBuffer, fileName } = e.data;
                            self.postMessage({ 
                                type: 'SUCCESS', 
                                payload: { 
                                    receivedArrayBuffer: arrayBuffer instanceof ArrayBuffer,
                                    size: arrayBuffer.byteLength,
                                    fileName: fileName
                                } 
                            });
                        } catch (error) {
                            self.postMessage({ type: 'ERROR', payload: error.message });
                        }
                    };
                `], { type: 'application/javascript' })));

                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => reject(new Error('File test timeout')), 5000);

                    worker.onmessage = (e) => {
                        clearTimeout(timeout);
                        const { type, payload } = e.data;
                        
                        if (type === 'SUCCESS') {
                            logResult('File ArrayBuffer serialization', payload.receivedArrayBuffer,
                                `${payload.fileName}: ${payload.size} bytes processed successfully`);
                        } else {
                            logResult('File serialization', false, payload);
                        }
                        resolve();
                    };

                    worker.postMessage({ 
                        arrayBuffer: arrayBuffer, 
                        fileName: file.name 
                    });
                });

            } catch (error) {
                logResult('File upload test', false, error.message);
            }
        }

        // Make functions globally available
        window.runSerializationTests = runSerializationTests;
        window.testWithMockData = testWithMockData;
        window.clearResults = clearResults;
        window.testFileUpload = testFileUpload;

        // Auto-run basic tests on page load
        logInfo('üîß OCR Serialization Verification Tool Loaded');
        logInfo('Click "Run Serialization Tests" to verify the DataCloneError fix');
    </script>
</body>
</html>