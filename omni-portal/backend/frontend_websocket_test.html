<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Frontend Test</title>
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .message { background-color: #e2e3e5; color: #383d41; padding: 10px; margin: 5px 0; border-radius: 4px; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
    </style>
</head>
<body>
    <h1>WebSocket Frontend Test</h1>
    <div id="status" class="status disconnected">Disconnected</div>
    
    <div>
        <button id="connectBtn" class="btn-primary">Connect WebSocket</button>
        <button id="disconnectBtn" class="btn-danger">Disconnect</button>
        <button id="triggerAlert" class="btn-success">Trigger Health Alert</button>
    </div>
    
    <h3>WebSocket Messages:</h3>
    <div id="messages"></div>

    <script>
        let pusher = null;
        let channel = null;
        
        const statusDiv = document.getElementById('status');
        const messagesDiv = document.getElementById('messages');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const triggerAlert = document.getElementById('triggerAlert');
        
        function addMessage(message, type = 'info') {
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            messageElement.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function updateStatus(status, isConnected) {
            statusDiv.textContent = status;
            statusDiv.className = `status ${isConnected ? 'connected' : 'disconnected'}`;
        }
        
        function connectWebSocket() {
            if (pusher) {
                pusher.disconnect();
            }
            
            addMessage('Attempting to connect to Laravel Reverb server...');
            
            pusher = new Pusher('vra4m4ukxphhlhweav9m', {
                wsHost: 'localhost',
                wsPort: 8080,
                wssPort: 8080,
                forceTLS: false,
                encrypted: false,
                disableStats: true,
                enabledTransports: ['ws', 'wss'],
                cluster: 'mt1',
            });
            
            pusher.connection.bind('connected', function() {
                updateStatus('Connected', true);
                addMessage(`‚úÖ Connected to WebSocket server! Socket ID: ${pusher.connection.socket_id}`);
                
                // Subscribe to public alerts channel
                channel = pusher.subscribe('public.alerts');
                
                channel.bind('pusher:subscription_succeeded', function() {
                    addMessage('‚úÖ Successfully subscribed to public.alerts channel');
                });
                
                // Listen for test messages
                channel.bind('test.message', function(data) {
                    addMessage(`üì® Test Message: ${JSON.stringify(data)}`);
                });
                
                // Listen for health risk alerts
                channel.bind('health.risk.alert', function(data) {
                    addMessage(`üö® Health Risk Alert: ${JSON.stringify(data)}`);
                });
                
                // Listen for system alerts
                channel.bind('system.alert', function(data) {
                    addMessage(`üîî System Alert: ${JSON.stringify(data)}`);
                });
                
                addMessage('üéß Listening for events: test.message, health.risk.alert, system.alert');
            });
            
            pusher.connection.bind('disconnected', function() {
                updateStatus('Disconnected', false);
                addMessage('‚ùå Disconnected from WebSocket server');
            });
            
            pusher.connection.bind('error', function(error) {
                updateStatus('Error', false);
                addMessage(`‚ùå WebSocket Error: ${JSON.stringify(error)}`);
            });
            
            pusher.connection.bind('state_change', function(states) {
                addMessage(`üîÑ Connection state: ${states.previous} ‚Üí ${states.current}`);
            });
        }
        
        function disconnectWebSocket() {
            if (pusher) {
                pusher.disconnect();
                pusher = null;
                channel = null;
            }
            updateStatus('Disconnected', false);
            addMessage('üîå Disconnected manually');
        }
        
        async function triggerHealthAlert() {
            try {
                addMessage('üì° Triggering health alert from backend...');
                const response = await fetch('/api/test/trigger-alert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        type: 'health_risk',
                        message: 'Test health alert from frontend'
                    })
                });
                
                if (response.ok) {
                    addMessage('‚úÖ Health alert triggered successfully');
                } else {
                    addMessage(`‚ùå Failed to trigger alert: ${response.status}`);
                }
            } catch (error) {
                addMessage(`‚ùå Error triggering alert: ${error.message}`);
            }
        }
        
        // Event listeners
        connectBtn.addEventListener('click', connectWebSocket);
        disconnectBtn.addEventListener('click', disconnectWebSocket);
        triggerAlert.addEventListener('click', triggerHealthAlert);
        
        // Auto-connect on page load
        addMessage('üöÄ Frontend WebSocket test loaded. Click Connect to start.');
    </script>
</body>
</html>