# Request ID Correlation System

This guide explains how request ID correlation works in the Omni Portal application for improved debugging, monitoring, and support.

## Overview

Request ID correlation ensures that every HTTP request between the frontend and backend can be traced and correlated for:

- **Debugging**: Trace requests across frontend and backend logs
- **Error Tracking**: Correlate errors with specific user interactions
- **Performance Monitoring**: Track request performance across the entire stack
- **Support**: Provide request IDs for faster issue resolution

## Architecture

### Components

1. **Backend Middleware**
   - `RequestIDMiddleware`: Generates/accepts X-Request-ID headers
   - `TracingMiddleware`: Includes request IDs in OpenTelemetry traces
   - `Handler`: Exception handler with request correlation

2. **Backend Utilities**
   - `RequestTraceHelper`: Logging and correlation utilities
   - Enhanced error responses with request IDs

3. **Frontend Utilities**
   - `request-correlation.ts`: ID generation and tracking
   - API client integration with correlation headers
   - Request lifecycle management

## Request Flow

```
1. Frontend generates request ID (or uses existing)
2. Frontend sends request with X-Request-ID header
3. Backend middleware captures/generates request ID
4. Backend logs all operations with request ID context
5. Backend includes request ID in response headers
6. Frontend correlates response with original request
```

## Usage

### Backend Usage

#### Generating Request IDs

Request IDs are automatically generated by `RequestIDMiddleware` if not provided by the client:

```php
// Request ID is automatically available in request attributes
$requestId = $request->attributes->get('request_id');

// Or use the helper method
$requestId = RequestIDMiddleware::getCurrentRequestId();
```

#### Logging with Request Context

Use `RequestTraceHelper` for request-aware logging:

```php
use App\Support\RequestTraceHelper;

// Log with automatic request context
RequestTraceHelper::info('Operation completed', ['result' => $data]);
RequestTraceHelper::error('Operation failed', ['error' => $error]);

// Log exceptions with full context
RequestTraceHelper::logException($exception, 'Custom message');
```

#### Creating API Responses

Create standardized responses with request correlation:

```php
use App\Support\RequestTraceHelper;

// Success response
return response()->json(
    RequestTraceHelper::createSuccessResponse($data, 'Operation successful')
);

// Error response
return response()->json(
    RequestTraceHelper::createErrorResponse('Operation failed', 400),
    400
);
```

#### Request Timing

Track operation performance:

```php
use App\Support\RequestTraceHelper;

// Start timing
RequestTraceHelper::startTiming('database_query');

// ... perform operation ...

// End timing (automatically logs duration)
$duration = RequestTraceHelper::endTiming('database_query');
```

### Frontend Usage

#### Automatic Correlation

All API calls through the `ApiService` automatically include request correlation:

```typescript
import api from '@/services/api';

// Request ID is automatically generated and included
const response = await api.get('/users');
console.log(response.error?.request_id); // Available in error responses
```

#### Manual Correlation

For custom requests, use the correlation utilities:

```typescript
import { correlatedFetch, generateRequestId } from '@/lib/request-correlation';

// Fetch with automatic correlation
const response = await correlatedFetch('/api/users');

// Manual request ID generation
const requestId = generateRequestId();
const customResponse = await fetch('/api/custom', {
  headers: {
    'X-Request-ID': requestId,
  },
});
```

#### Request Tracking

Monitor request lifecycle:

```typescript
import { requestCorrelationManager } from '@/lib/request-correlation';

// View active requests
const activeRequests = requestCorrelationManager.getActiveRequests();

// Get specific request data
const requestData = requestCorrelationManager.getActiveRequest(requestId);
```

## Request ID Format

Request IDs follow this format: `req_YYYYMMDDHHMMSS_randomString`

Example: `req_20240915143022_a8b9c1d2`

This format provides:
- **Sortability**: Timestamp prefix for chronological ordering
- **Uniqueness**: Random suffix to prevent collisions
- **Readability**: Clear prefix indicating it's a request ID

## Error Correlation

### Backend Error Responses

All API errors include request correlation data:

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "The given data was invalid.",
    "request_id": "req_20240915143022_a8b9c1d2",
    "timestamp": "2024-09-15T14:30:22.123Z"
  },
  "errors": {
    "email": ["The email field is required."]
  }
}
```

### Frontend Error Handling

Errors include correlation data for debugging:

```typescript
try {
  await api.post('/users', userData);
} catch (error) {
  if (error.response?.data?.error?.request_id) {
    console.log('Request ID for support:', error.response.data.error.request_id);
  }
}
```

## Logging Integration

### Backend Logging

All logs automatically include request context when using `RequestTraceHelper`:

```
[2024-09-15 14:30:22] local.INFO: User login successful
{
  "request_id": "req_20240915143022_a8b9c1d2",
  "user_id": 123,
  "ip_address": "192.168.1.100",
  "method": "POST",
  "url": "https://api.example.com/auth/login",
  "timestamp": "2024-09-15T14:30:22.123Z"
}
```

### Frontend Logging

Frontend logs include correlation data:

```
[req_20240915143022_a8b9c1d2] Request started
{
  "request_id": "req_20240915143022_a8b9c1d2",
  "correlation": {
    "timestamp": "2024-09-15T14:30:22.123Z",
    "method": "POST",
    "url": "/auth/login"
  }
}
```

## OpenTelemetry Integration

Request IDs are included in OpenTelemetry traces:

- `request.id`: Primary request identifier
- `trace.id`: Trace correlation
- `correlation.id`: Cross-service correlation

## Performance Monitoring

The system tracks request performance:

- **Request Duration**: Automatic timing for all requests
- **Memory Usage**: Memory consumption per request
- **Database Queries**: Query performance correlation
- **Error Rates**: Error correlation by request pattern

## Support and Debugging

### For Support Teams

When users report issues, ask for:
1. **Request ID** from error messages
2. **Timestamp** of the issue
3. **User actions** that led to the error

### For Developers

Use request IDs to:
1. **Trace requests** through logs
2. **Correlate frontend/backend** events
3. **Debug performance issues**
4. **Analyze error patterns**

### Log Queries

Search logs by request ID:

```bash
# Laravel logs
grep "req_20240915143022_a8b9c1d2" storage/logs/laravel.log

# Application logs
grep "request_id.*req_20240915143022_a8b9c1d2" storage/logs/app.log
```

## Configuration

### Backend Configuration

Request ID middleware is automatically registered in `app/Http/Kernel.php`:

```php
protected $middleware = [
    // ... other middleware
    \App\Http\Middleware\RequestIDMiddleware::class,
    \App\Http\Middleware\TracingMiddleware::class,
];
```

### Frontend Configuration

Request correlation is automatically configured in API services. No additional setup required.

## Best Practices

### Backend

1. **Always use RequestTraceHelper** for logging
2. **Include request IDs** in API responses
3. **Log exceptions** with full context
4. **Use timing helpers** for performance tracking

### Frontend

1. **Use ApiService** for automatic correlation
2. **Handle request IDs** in error responses
3. **Log correlation data** for debugging
4. **Provide request IDs** in support requests

### General

1. **Never log sensitive data** in correlation context
2. **Use consistent request ID format**
3. **Clean up old correlation data**
4. **Monitor correlation performance impact**

## Troubleshooting

### Common Issues

1. **Missing Request IDs**: Ensure middleware is properly registered
2. **Correlation Mismatch**: Check header name consistency
3. **Memory Leaks**: Verify cleanup intervals are running
4. **Performance Impact**: Monitor correlation overhead

### Debug Steps

1. Check request headers for `X-Request-ID`
2. Verify middleware execution order
3. Review log entries for correlation data
4. Test request/response correlation
5. Validate cleanup processes

## API Reference

### RequestIDMiddleware

- `REQUEST_ID_HEADER`: Header name constant
- `getCurrentRequestId()`: Get current request ID
- `getRequestId($request)`: Get request ID from request

### RequestTraceHelper

- `info($message, $context)`: Log info with context
- `error($message, $context)`: Log error with context  
- `logException($exception, $message)`: Log exception
- `createSuccessResponse($data)`: Create success response
- `createErrorResponse($message, $code)`: Create error response

### Frontend Utilities

- `generateRequestId()`: Generate unique request ID
- `getCorrelationHeaders()`: Get correlation headers
- `correlatedFetch()`: Fetch with correlation
- `requestCorrelationManager`: Request tracking manager

## Security Considerations

- Request IDs don't contain sensitive information
- Correlation data is sanitized in logs
- Production logs hide internal details
- Request IDs help with security auditing
- No PII is included in correlation context